name: Deploy to Azure VM

on:
  push:
    branches: ["main"] # lÃ¤uft bei jedem Push auf main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Copy project files to VM
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.AZURE_HOST }}
          username: ${{ secrets.AZURE_USER }}
          key: ${{ secrets.AZURE_SSH_KEY }}
          source: "."
          target: "/home/davide/tv"

      - name: Create .env on VM
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.AZURE_HOST }}
          username: ${{ secrets.AZURE_USER }}
          key: ${{ secrets.AZURE_SSH_KEY }}
          script: |
            cd /home/davide/tv/backend
            echo "PORT=${{ secrets.PORT }}" > .env
            echo "SUPABASE_URL=${{ secrets.SUPABASE_URL }}" >> .env
            echo "SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}" >> .env
            echo "POLITICS_API_KEY=${{ secrets.POLITICS_API_KEY }}" >> .env
            echo "HF_ACCESS_TOKEN=${{ secrets.HF_ACCESS_TOKEN }}" >> .env

      - name: Restart app on VM
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.AZURE_HOST }}
          username: ${{ secrets.AZURE_USER }}
          key: ${{ secrets.AZURE_SSH_KEY }}
          script: |
            cd /home/davide/tv/backend
            npm install
            npm run build
            pm2 restart tv || pm2 start dist/app.js --name tv
            pm2 save
