name: Daily Crawl Script

on:
  schedule:
    # Run daily at midnight UTC (0 0 * * *)
    - cron: "0 0 * * *"
  workflow_dispatch:  # Allow manual triggering from GitHub UI

jobs:
  run-crawl:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: |
          cd frontend
          npm install

      - name: Run crawl script
        run: |
          # Make API call with Bearer token
          CRAWL_URL="${{ secrets.DEPLOYMENT_URL }}/api/crawl/all"
          CRAWL_KEY="${{ secrets.CRAWL_API_KEY }}"

          response=$(curl --write-out "%{http_code}" \
            --silent --output /dev/null \
            -X POST \
            -H "Authorization: Bearer $CRAWL_KEY" \
            "$CRAWL_URL")

          if [ "$response" -ne 200 ]; then
            echo "::error::Crawl API request failed with status code $response"
            exit 1
          else
            echo "Successfully triggered crawl script."
          fi
