name: Daily Crawl Script

on:
  schedule:
    # Run daily at 2 AM UTC (0 2 * * *)
    - cron: "0 2 * * *"
  workflow_dispatch: # Allow manual triggering from GitHub UI

jobs:
  run-crawl:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install dependencies
        run: |
          cd frontend
          npm install

      - name: Run crawl script
        run: |
          # Make API call with Bearer token
          CRAWL_URL="${{ secrets.DEPLOYMENT_URL }}/api/crawl/all"

          response=$(curl --write-out "%{http_code}" \
            --silent --output /dev/null \
            -X POST \
            --header "Authorization: Bearer ${{ secrets.NEXT_PUBLIC_CRAWL_API_KEY }}" \
            "$CRAWL_URL")

          if [ "$response" -ne 200 ]; then
            echo "::error::Crawl API request failed with status code $response"
            exit 1
          else
            echo "Successfully triggered crawl script."
          fi
