# Migration zu Supabase - Übersicht

## ✅ Durchgeführte Änderungen

### 1. Supabase Client Installation

- `@supabase/supabase-js` wurde installiert
- Neue Supabase-Konfiguration in `/lib/supabase.ts` erstellt

### 2. Umstellung der Datenbank-Integration

#### Neue Dateien:

- `/lib/supabase.ts` - Supabase Client Konfiguration und Typen
- `/lib/supabase-server-utils.ts` - Serverside Utilities für Supabase
- `.env.local.example` - Beispiel für Umgebungsvariablen

#### Aktualisierte Dateien:

- `/app/api/politics/route.ts` - Komplett auf Supabase umgestellt
- `/app/api/crawl/maischberger/route.ts` - Server-Utils auf Supabase umgestellt
- `/app/api/crawl/lanz/route.ts` - Server-Utils auf Supabase umgestellt
- `/app/api/crawl/illner/route.ts` - Server-Utils auf Supabase umgestellt
- `/app/api/crawl/miosga/route.ts` - Server-Utils auf Supabase umgestellt

### 3. Benötigte Umgebungsvariablen

Du musst folgende Variablen in deiner `.env.local` Datei setzen:

```bash
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url_here
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key_here
```

### 4. Supabase Tabellen-Schema

Die Anwendung erwartet eine Tabelle `tv_show_politicians` mit folgenden Spalten:

```sql
create table public.tv_show_politicians (
  id serial not null,
  show_name text not null,
  episode_date date not null,
  politician_name text not null,
  party_name text null,
  politician_id integer null,
  party_id integer null,
  created_at timestamp with time zone null default now(),
  updated_at timestamp with time zone null default now(),
  abgeordnetenwatch_url text null,
  tv_channel public.tv_channel null,
  constraint tv_show_politicians_pkey primary key (id),
  constraint tv_show_politicians_show_name_episode_date_politician_id_key unique (show_name, episode_date, politician_id)
) TABLESPACE pg_default;

create index IF not exists idx_tv_show_politicians_show_date on public.tv_show_politicians using btree (show_name, episode_date) TABLESPACE pg_default;

create index IF not exists idx_tv_show_politicians_politician on public.tv_show_politicians using btree (politician_id) TABLESPACE pg_default;

create index IF not exists idx_tv_show_politicians_party on public.tv_show_politicians using btree (party_id) TABLESPACE pg_default;

create index IF not exists tv_show_politicians_show_date_idx on public.tv_show_politicians using btree (show_name, episode_date) TABLESPACE pg_default;

create index IF not exists tv_show_politicians_show_channel_idx on public.tv_show_politicians using btree (show_name, tv_channel) TABLESPACE pg_default;

create index IF not exists tv_show_politicians_party_idx on public.tv_show_politicians using btree (party_name) TABLESPACE pg_default;

create index IF not exists tv_show_politicians_politician_idx on public.tv_show_politicians using btree (politician_name) TABLESPACE pg_default;
```

`````sql
create table public.tv_show_episode_political_areas (
  id bigint generated by default as identity not null,
  show_name text null,
  episode_date date null,
  political_area_id smallint null,
  created_at timestamp with time zone not null default now(),
  tv_channel public.tv_channel null,
  constraint tv_show_episode_political_areas_pkey primary key (id),
  constraint unique_show_episode_political_area unique (show_name, episode_date, political_area_id),
  constraint fk_political_area foreign KEY (political_area_id) references political_area (id)
) TABLESPACE pg_default;
´´´

````sql
create table public.show_links (
  id bigint generated by default as identity not null,
  show_name text null,
  episode_url text null,
  episode_date date null,
  constraint show_linka_pkey primary key (id),
  constraint unique_show_episode_link unique (show_name, episode_date)
) TABLESPACE pg_default;
´´´

### 5. API-Funktionalität

Alle bestehenden API-Endpunkte funktionieren weiterhin gleich:

#### Politics API (`/api/politics`)

- `GET /api/politics?type=party-stats` - Partei-Statistiken
- `GET /api/politics?type=episodes` - Episoden mit Politiker-Anzahl
- `GET /api/politics?type=recent` - Letzte Auftritte
- `GET /api/politics?type=summary` - Gesamt-Statistiken
- `GET /api/politics?type=detailed-appearances` - Detaillierte Auftritte
- `GET /api/politics?type=shows` - Liste der Shows

#### Crawler APIs

- `POST /api/crawl/maischberger` - Maischberger Crawler
- `POST /api/crawl/lanz` - Lanz Crawler
- `POST /api/crawl/illner` - Illner Crawler
- `POST /api/crawl/miosga` - Miosga Crawler
- `DELETE /api/crawl/maischberger` - Lösche Maischberger Daten

### 6. Änderungen in der Funktionsweise

#### Supabase vs. SQLite Unterschiede:

- **Upserts**: Verwendet jetzt Supabase's `upsert()` anstatt SQLite's `INSERT OR IGNORE`
- **Async/Await**: Alle Datenbankoperationen sind jetzt asynchron
- **Fehlerbehandlung**: Verbesserte Fehlerbehandlung mit Supabase-spezifischen Fehlern
- **Batch-Operations**: Bessere Performance durch Batch-Inserts
- **Type Safety**: Verbesserte TypeScript-Typen für Datenbankoperationen

### 7. Migration Schritte

1. **Supabase Projekt erstellen**: Erstelle ein neues Supabase Projekt
2. **Tabelle erstellen**: Führe das oben genannte SQL-Schema aus
3. **Umgebungsvariablen setzen**: Füge die Supabase Credentials hinzu
4. **Daten migrieren** (optional): Importiere bestehende SQLite-Daten nach Supabase
5. **Testen**: Alle API-Endpunkte sollten funktionieren

### 8. Vorteile der Migration

- ✅ **Cloud-basiert**: Keine lokale Datenbankdatei mehr nötig
- ✅ **Skalierbar**: Automatisches Scaling durch Supabase
- ✅ **Echtzeit**: Möglichkeit für Echtzeit-Features
- ✅ **Backup**: Automatische Backups durch Supabase
- ✅ **Multi-User**: Gleichzeitiger Zugriff möglich
- ✅ **Performance**: Bessere Query-Performance bei größeren Datenmengen
- ✅ **Administration**: Web-Interface für Datenbankadministration

### 9. Troubleshooting

**Fehler "Missing Supabase environment variables":**

- Prüfe ob `.env.local` existiert und die korrekten Variablen enthält

**"relation 'tv_show_politicians' does not exist":**

- Führe das SQL-Schema in deinem Supabase Projekt aus

**Crawler funktioniert nicht:**

- Prüfe ob die Tabelle die richtigen Spalten und Constraints hat
- Prüfe die Supabase-Permissions (RLS Policies)

** Fehlende Politiker URL nachträglich in der Tabelle hinzufügen **

```SQL
UPDATE public.tv_show_politicians
SET abgeordnetenwatch_url = 'https://www.abgeordnetenwatch.de/profile/' ||
                            lower(replace(politician_name, ' ', '-'))
WHERE politician_name IS NOT NULL;
`````

---

Die Migration ist abgeschlossen! Das Frontend verwendet jetzt ausschließlich Supabase als Datenbank.
